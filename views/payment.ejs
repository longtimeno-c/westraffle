<div class="max-w-4xl mx-auto">
    <div class="card-gradient rounded-xl shadow-xl overflow-hidden">
        <div class="p-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-8">
                <%= isBid ? 'Place Your Bid' : 'Purchase Tickets' %>
            </h1>
            
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-600"><%= isBid ? 'Bid Amount:' : 'Amount to Pay:' %></span>
                    <span class="text-2xl font-bold text-raffle-primary">$<%= amount.toFixed(2) %></span>
                </div>
                <% if (typeof quantity !== 'undefined') { %>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Number of Tickets:</span>
                        <span class="font-semibold text-gray-800"><%= quantity %></span>
                    </div>
                <% } %>
                <% if (isBid) { %>
                    <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-yellow-800 text-sm">
                            <span class="font-semibold">Note:</span> Your payment will be held until your bid is either:
                            <ul class="list-disc ml-6 mt-2">
                                <li>Outbid by another participant</li>
                                <li>Won at the end of the auction</li>
                            </ul>
                        </p>
                    </div>
                <% } %>
            </div>

            <div class="bg-white rounded-lg p-6 shadow-sm mb-8">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Payment Details</h2>
                <form id="payment-form" class="space-y-6">
                    <div id="payment-element" class="min-h-[200px]"></div>
                    <div id="error-message" class="text-red-500 hidden"></div>
                    <button id="submit-button" class="btn-primary w-full py-4 text-lg relative">
                        <span id="button-text">
                            <%= isBid ? 'Place Bid' : 'Pay Now' %>
                        </span>
                        <div id="spinner" class="hidden">
                            <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></div>
                        </div>
                    </button>
                </form>
            </div>

            <div class="text-center text-sm text-gray-500">
                <p>Secure payment powered by Stripe</p>
                <div class="flex justify-center space-x-4 mt-2">
                    <img src="https://stripe.com/img/v3/home/social.png" alt="Stripe" class="h-6">
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('<%= publicKey %>');
    const clientSecret = '<%= clientSecret %>';

    const appearance = {
        theme: 'stripe',
        variables: {
            colorPrimary: '#4f46e5',
            colorBackground: '#ffffff',
            colorText: '#1f2937',
            colorDanger: '#ef4444',
            fontFamily: 'ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
            spacingUnit: '4px',
            borderRadius: '8px',
        },
    };

    const elements = stripe.elements({ appearance, clientSecret });
    const paymentElement = elements.create('payment', {
        layout: {
            type: 'tabs',
            defaultCollapsed: false,
            radios: true,
        },
        paymentMethodOrder: ['card', 'apple_pay', 'google_pay'],
    });
    paymentElement.mount('#payment-element');

    const form = document.getElementById('payment-form');
    const submitButton = document.getElementById('submit-button');
    const spinner = document.getElementById('spinner');
    const buttonText = document.getElementById('button-text');
    const errorMessage = document.getElementById('error-message');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        // Disable form submission while processing
        submitButton.disabled = true;
        spinner.classList.remove('hidden');
        buttonText.classList.add('opacity-0');

        try {
            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: window.location.origin + '/raffles/<%= raffle.id %>?success=true',
                },
            });

            if (error) {
                errorMessage.textContent = error.message;
                errorMessage.classList.remove('hidden');
                submitButton.disabled = false;
                spinner.classList.add('hidden');
                buttonText.classList.remove('opacity-0');
            }
        } catch (error) {
            console.error('Payment failed:', error);
            errorMessage.textContent = 'An unexpected error occurred. Please try again.';
            errorMessage.classList.remove('hidden');
            submitButton.disabled = false;
            spinner.classList.add('hidden');
            buttonText.classList.remove('opacity-0');
        }
    });
</script> 